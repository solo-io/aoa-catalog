apiVersion: security.policy.gloo.solo.io/v2
kind: ExtAuthPolicy
metadata:
  name: httpbin-extauth
  namespace: httpbin
spec:
  applyToRoutes:
  - route:
      labels:
        oauth: httpbin.demo.glooplatform.com
  config:
    server:
      name: mgmt-ext-auth-server
      namespace: gloo-mesh
      cluster: mgmt
    glooAuth:
      configs:
      - oauth2:
          oidcAuthorizationCode:
            appUrl: https://httpbin.demo.glooplatform.com
            callbackPath: /callback
            clientId: 0oa6qvzybcVCK6PcS5d7
            clientSecretRef:
              name: okta-client-secret
              namespace: gloo-mesh
            issuerUrl: https://dev-22653158.okta.com/oauth2/default
            session:
              failOnFetchFailure: true
              cookie:   
                allowRefreshing: true # sets the refresh_token in cookie header
              redis:
                cookieName: okta-session
                options:
                  host: redis.gloo-mesh-addons:6379
                allowRefreshing: true        
              cookieOptions: # client side set-cookie options
                maxAge: "3600"
            scopes:
            - email
            - offline_access
            logoutPath: /logout
            afterLogoutUrl: /get
            headers:
              #idTokenHeader: Jwt
              idTokenHeader: x-id-token
              accessTokenHeader: x-access-token
      #- oauth2:
      #    accessTokenValidation:
      #      introspectionUrl: https://dev-22653158.okta.com/oauth2/v1/introspect
      - opaAuth:
          modules:
          - name: httpbin-opa
            namespace: httpbin
          query: "data.ehs.allow == true"