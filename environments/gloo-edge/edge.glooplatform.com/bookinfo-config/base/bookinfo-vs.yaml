apiVersion: gateway.solo.io/v1
kind: VirtualService
metadata:
  name: bookinfo-vs
  namespace: gloo-system
spec:
  sslConfig:
    secretRef:
      name: cf-advanced-tls-secret
      namespace: gloo-system
  virtualHost:
    domains:
    - 'bookinfo.edge.glooplatform.com'
    routes:
    - matchers:
      - headers:
         - name: user
           value: jason
        prefix: /
      routeAction:
        single:
          upstream:
            name: bookinfo-v2-productpage-9080
            namespace: gloo-system
    - matchers:
      - prefix: /
      routeAction:
        multi:
          destinations:
          - destination:
              upstream:
                name: bookinfo-v1-productpage-9080
                namespace: gloo-system
            weight: 50
          - destination:
              upstream:
                name: bookinfo-v2-productpage-9080
                namespace: gloo-system
            weight: 50
    options:
      extauth:
        configRef:
          name: apikey-auth
          namespace: gloo-system
      waf:
        configMapRuleSets:
           - configMapRef:
               name: wafrulesets
               namespace: gloo-system
        customInterventionMessage: 'ModSecurity intervention! Custom message details here..'
      #jwt:
      #  providers:
      #    solo-provider:
      #      issuer: solo.io
      #      jwks:
      #        remote:
      #          upstreamRef:
      #            name: gloo-system-jwks-server-80
      #            namespace: gloo-system
      #          url: http://jwks-server/jwks.json
      jwt:
        providers:
          solo:
            tokenSource:
              headers:
              - header: x-token
              queryParams:
              - token
            claimsToHeaders:
            - claim: org
              header: x-company
            issuer: solo.io
            jwks:
              local:
                key: |
                  -----BEGIN PUBLIC KEY-----
                  MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu1SU1LfVLPHCozMxH2Mo
                  4lgOEePzNm0tRgeLezV6ffAt0gunVTLw7onLRnrq0/IzW7yWR7QkrmBL7jTKEn5u
                  +qKhbwKfBstIs+bMY2Zkp18gnTxKLxoS2tFczGkPLPgizskuemMghRniWaoLcyeh
                  kd3qqGElvW/VDL5AaWTg0nLVkjRo9z+40RQzuVaE8AkAFmxZzow3x+VJYKdjykkJ
                  0iT9wCS0DRTXu269V264Vf/3jvredZiKRkgwlL9xNAwxXFg0x/XFw005UWVRIkdg
                  cKWTjpBP2dPwVZ4WWC+9aGVd+Gyn1o0CLelf4rEjGoXbAAEgAqeGUxrcIlbjXfbc
                  mwIDAQAB
                  -----END PUBLIC KEY-----